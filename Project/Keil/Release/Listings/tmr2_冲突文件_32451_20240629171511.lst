C51 COMPILER V9.60.7.0   TMR2                                                              06/06/2024 17:04:34 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE TMR2
OBJECT MODULE PLACED IN .\Release\Objects\tmr2.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE ..\..\Hardware\tmr2.c LARGE OPTIMIZE(8,SIZE) BROWSE INTVECTOR(0X000C) IN
                    -CDIR(..\..\Libraries\Include;..\..\User;..\..\User\lib;..\..\Hardware;..\..\Lowpower) INTERVAL(3) DEBUG OBJECTEXTEND PRI
                    -NT(.\Release\Listings\tmr2.lst) TABS(2) OBJECT(.\Release\Objects\tmr2.obj)

line level    source

   1          // ¶¨Ê±Æ÷TMR2µÄÇý¶¯Ô´ÎÄ¼þ
   2          #include "tmr2.h"
   3          
   4          // volatile unsigned char tmr2_flag = 0; // tmr2ÖÐ¶Ï·þÎñº¯ÊýÖÐ»áÖÃÎ»µÄ±êÖ¾Î»
   5          volatile u32 tmr2_cnt = 0;            // ¶¨Ê±Æ÷TMR2µÄ¼ÆÊýÖµ£¨Ã¿´ÎÔÚÖÐ¶Ï·þÎñº¯ÊýÖÐ»á¼ÓÒ»£©
   6          
   7          /**
   8           * @brief ÅäÖÃ¶¨Ê±Æ÷TMR2
   9           */
  10          void tmr2_config(void)
  11          {
  12   1          // ÅäÖÃ¶¨Ê±Æ÷£¬ÓÃÀ´¼ÇÂ¼RF½ÓÊÕµ½µÄ¸ßµçÆ½³ÖÐøÊ±¼ä
  13   1          __SetIRQnIP(TMR2_IRQn, TMR2_IQn_CFG); // ÉèÖÃÖÐ¶ÏÓÅÏÈ¼¶£¨TMR2£©
  14   1      
  15   1          TMR2_CONL &= ~TMR_PRESCALE_SEL(0x03); // Çå³ýTMR2µÄÔ¤·ÖÆµÅäÖÃ¼Ä´æÆ÷
  16   1          // ÅäÖÃTMR2µÄÔ¤·ÖÆµ£¬Îª32·ÖÆµ£¬¼´21MHz / 32 = 0.67MHz£¬Ô¼0.67us¼ÆÊýÒ»´Î
  17   1          // £¨Êµ¼Ê²âÊÔºÍ¼ÆËãµÃ³öÕâ¸öÏµÍ³Ê±ÖÓÊÇ21MHzµÄ£¬µ«ÊÇ»¹ÊÇÓÐÐ©Îó²î£¬²»ÊÇ×¼È·µÄ21MHz£©
  18   1          TMR2_CONL |= TMR_PRESCALE_SEL(0x05);
  19   1          TMR2_CONL &= ~TMR_MODE_SEL(0x03); // Çå³ýTMR2µÄÄ£Ê½ÅäÖÃ¼Ä´æÆ÷
  20   1          TMR2_CONL |= TMR_MODE_SEL(0x01);  // ÅäÖÃTMR2µÄÄ£Ê½Îª¼ÆÊýÆ÷Ä£Ê½£¬×îºó¶ÔÏµÍ³Ê±ÖÓµÄÂö³å½øÐÐ¼ÆÊý
  21   1      
  22   1          TMR2_CONH &= ~TMR_PRD_PND(0x01); // Çå³ýTMR2µÄ¼ÆÊý±êÖ¾Î»£¬±íÊ¾Î´Íê³É¼ÆÊý
  23   1          TMR2_CONH |= TMR_PRD_IRQ_EN(1);  // Ê¹ÄÜTMR2µÄ¼ÆÊýÖÐ¶Ï
  24   1      
  25   1          // ÅäÖÃTMR2µÄ¼ÆÊýÖÜÆÚ
  26   1          TMR2_PRL = (unsigned char)(TMR2_CNT_TIME % 255);
  27   1          TMR2_PRH = (unsigned char)(TMR2_CNT_TIME / 255);
  28   1      
  29   1          // Çå³ýTMR2µÄ¼ÆÊýÖµ
  30   1          TMR2_CNTL = 0;
  31   1          TMR2_CNTH = 0;
  32   1      
  33   1          TMR2_CONL &= ~(TMR_SOURCE_SEL(0x07)); // Çå³ýTMR2µÄÊ±ÖÓÔ´ÅäÖÃ¼Ä´æÆ÷
  34   1          // TMR2_CONL |= TMR_SOURCE_SEL(0x07); // ÅäÖÃTMR2µÄÊ±ÖÓÔ´£¬Ê¹ÓÃÏµÍ³Ê±ÖÓ
  35   1          TMR2_CONL |= TMR_SOURCE_SEL(0x05); // ÅäÖÃTMR2µÄÊ±ÖÓÔ´£¬²»ÓÃÈÎºÎÊ±ÖÓ
  36   1                                             // __EnableIRQ(TMR2_IRQn);        // Ê¹ÄÜÖÐ¶Ï
  37   1      
  38   1          __DisableIRQ(TMR2_IRQn); // ½ûÓÃÖÐ¶Ï
  39   1          IE_EA = 1;               // ´ò¿ª×ÜÖÐ¶Ï
  40   1      }
  41          
  42          /**
  43           * @brief ¿ªÆô¶¨Ê±Æ÷TMR2£¬¿ªÊ¼¼ÆÊ±
  44           */
  45          void tmr2_enable(void)
  46          {
  47   1          // ÖØÐÂ¸øTMR2ÅäÖÃÊ±ÖÓ
  48   1          TMR2_CONL &= ~(TMR_SOURCE_SEL(0x07)); // Çå³ý¶¨Ê±Æ÷µÄÊ±ÖÓÔ´ÅäÖÃ¼Ä´æÆ÷
  49   1          TMR2_CONL |= TMR_SOURCE_SEL(0x06);    // ÅäÖÃ¶¨Ê±Æ÷µÄÊ±ÖÓÔ´£¬Ê¹ÓÃÏµÍ³Ê±ÖÓ£¨Ô¼21MHz£©
  50   1      
  51   1          __EnableIRQ(TMR2_IRQn); // Ê¹ÄÜÖÐ¶Ï
  52   1          IE_EA = 1;              // ´ò¿ª×ÜÖÐ¶Ï
  53   1      }
C51 COMPILER V9.60.7.0   TMR2                                                              06/06/2024 17:04:34 PAGE 2   

  54          
  55          /**
  56           * @brief ¹Ø±Õ¶¨Ê±Æ÷2£¬Çå¿Õ¼ÆÊýÖµ
  57           */
  58          void tmr2_disable(void)
  59          {
  60   1          // ²»¸ø¶¨Ê±Æ÷Ìá¹©Ê±ÖÓ£¬ÈÃËüÍ£Ö¹¼ÆÊý
  61   1          TMR2_CONL &= ~(TMR_SOURCE_SEL(0x07)); // Çå³ý¶¨Ê±Æ÷µÄÊ±ÖÓÔ´ÅäÖÃ¼Ä´æÆ÷
  62   1          TMR2_CONL |= TMR_SOURCE_SEL(0x05);    // ÅäÖÃ¶¨Ê±Æ÷µÄÊ±ÖÓÔ´£¬²»ÓÃÈÎºÎÊ±ÖÓ
  63   1      
  64   1          // Çå³ý¶¨Ê±Æ÷µÄ¼ÆÊýÖµ
  65   1          TMR2_CNTL = 0;
  66   1          TMR2_CNTH = 0;
  67   1      
  68   1          __DisableIRQ(TMR2_IRQn); // ¹Ø±ÕÖÐ¶Ï£¨²»Ê¹ÄÜÖÐ¶Ï£©
  69   1      }
  70          
  71          // ¶¨Ê±Æ÷ÅäÖÃ³ÉPWMÊä³öÄ£Ê½£¨µ÷ÓÃ¸Ãº¯ÊýÇ°£¬ÒªÏÈ½«¶ÔÓ¦µÄIO¸´ÓÃµ½¶¨Ê±Æ÷µÄPWMÊä³öÉÏ£©
  72          void tmr2_pwm_config(void)
  73          {
  74   1          //  ÅäÖÃP24Îªtimer2µÄPWMÊä³ö¶Ë¿Ú
  75   1          P2_MD1 &= ~GPIO_P24_MODE_SEL(0x3); // ÇåÁã
  76   1          P2_MD1 |= GPIO_P24_MODE_SEL(0x1);  // Êä³öÄ£Ê½
  77   1          FOUT_S24 = GPIO_FOUT_TMR2_PWMOUT;  // ¸´ÓÃ³ÉTMRµÄPWMÊä³ö
  78   1      
  79   1          // #define PEROID_VAL (SYSCLK / 128 / 10000 - 1) // ÖÜÆÚÖµ=ÏµÍ³Ê±ÖÓ/·ÖÆµ/ÆµÂÊ - 1     // 10KHz
  80   1          #define PEROID_VAL (SYSCLK / 128 / 1000 - 1) // ÖÜÆÚÖµ=ÏµÍ³Ê±ÖÓ/·ÖÆµ/ÆµÂÊ - 1     // 1KHz
  81   1          // #define PEROID_VAL (SYSCLK / 128 / 100 - 1) // ÖÜÆÚÖµ=ÏµÍ³Ê±ÖÓ/·ÖÆµ/ÆµÂÊ - 1     // 100Hz
  82   1      // #define PEROID_VAL (SYSCLK / 128 / 10 - 1) // ÖÜÆÚÖµ=ÏµÍ³Ê±ÖÓ/·ÖÆµ/ÆµÂÊ - 1     // 10Hz
  83   1      
  84   1          // ÅäÖÃÆµÂÊÎª1kHZ£¬50%Õ¼¿Õ±ÈµÄPWM    PWMÆµÂÊ=ÏµÍ³Ê±ÖÓ/·ÖÆµ/(ÖÜÆÚÖµ+1)
  85   1          TMR_ALLCON = TMR2_CNT_CLR(0x1);                        // Çå³ý¼ÆÊýÖµ
  86   1          TMR2_PRH = TMR_PERIOD_VAL_H((PEROID_VAL >> 8) & 0xFF); // ÖÜÆÚÖµ
  87   1          TMR2_PRL = TMR_PERIOD_VAL_L((PEROID_VAL >> 0) & 0xFF);
  88   1          TMR2_PWMH = TMR_PWM_VAL_H(((PEROID_VAL / 2) >> 8) & 0xFF); // Õ¼¿Õ±ÈÉèÖÃÖµ
  89   1          TMR2_PWML = TMR_PWM_VAL_L(((PEROID_VAL / 2) >> 0) & 0xFF);
  90   1          TMR2_CONH = TMR_PRD_PND(0x1) | TMR_PRD_IRQ_EN(0x1);                          // Ê¹ÄÜ¼ÆÊýÖÐ¶Ï
  91   1          TMR2_CONL = TMR_SOURCE_SEL(0x7) | TMR_PRESCALE_SEL(0x7) | TMR_MODE_SEL(0x2); // Ñ¡ÔñÏµÍ³Ê±ÖÓ£¬128·ÖÆµ£
             -¬PWMÄ£Ê½
  92   1      }
  93          
  94          // TMR2ÖÐ¶Ï·þÎñº¯Êý
  95          void TIMR2_IRQHandler(void) interrupt TMR2_IRQn
  96          {
  97   1      #if 1 // ¶¨Ê±Æ÷µÄ¶¨Ê±ÖÐ¶Ï
  98   1          // ½øÈëÖÐ¶ÏÉèÖÃIP£¬²»¿ÉÉ¾³ý
  99   1          __IRQnIPnPush(TMR2_IRQn);
 100   1      
 101   1          // ---------------- ÓÃ»§º¯Êý´¦Àí -------------------
 102   1      
 103   1          // ÖÜÆÚÖÐ¶Ï
 104   1          if (TMR2_CONH & TMR_PRD_PND(0x1))
 105   1          {
 106   2              TMR2_CONH |= TMR_PRD_PND(0x1); // Çå³ýpending
 107   2      
 108   2              tmr2_cnt++; // Ã¿5ms¼ÓÒ»´Î
 109   2          }
 110   1      
 111   1          // ÍË³öÖÐ¶ÏÉèÖÃIP£¬²»¿ÉÉ¾³ý
 112   1          __IRQnIPnPop(TMR2_IRQn);
 113   1      #endif
 114   1      }
C51 COMPILER V9.60.7.0   TMR2                                                              06/06/2024 17:04:34 PAGE 3   



MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    242    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =      4    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
