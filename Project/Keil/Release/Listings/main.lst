C51 COMPILER V9.60.7.0   MAIN                                                              07/04/2025 17:19:03 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Release\Objects\main.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE ..\..\User\main.c LARGE OPTIMIZE(8,SIZE) BROWSE INTVECTOR(0X000C) INCDIR
                    -(..\..\Libraries\Include;..\..\User;..\..\User\lib;..\..\Hardware;..\..\Lowpower) INTERVAL(3) DEBUG OBJECTEXTEND PRINT(.
                    -\Release\Listings\main.lst) OBJECT(.\Release\Objects\main.obj)

line level    source

   1          // use encoding UTF-8
   2          #include "include.h"
   3          #include "my_config.h"
   4          
   5          volatile bit flag_kind_of_bat = 0;
   6          
   7          volatile bit flag_is_charging_detected = 0; // æ ‡å¿—ä½ï¼Œæ˜¯å¦æ£€æµ‹åˆ°å……ç”µ
   8          volatile bit flag_is_in_charging = 0;       // æ ‡å¿—ä½ï¼Œæ˜¯å¦åœ¨å……ç”µï¼Œæ˜¯å¦æ‰“å¼€äº†æ§åˆ¶å……ç”µçš
             -„PWM
   9          volatile bit flag_is_adjust_pwm_time_comes = 0;
  10          
  11          volatile bit flag_is_led_25_percent_enable = 0; // æ ‡å¿—ä½ï¼ŒæŒ‡ç¤ºç¯æ˜¯å¦ä½¿èƒ½
  12          volatile bit flag_is_led_50_percent_enable = 0; // æ ‡å¿—ä½ï¼ŒæŒ‡ç¤ºç¯æ˜¯å¦ä½¿èƒ½
  13          volatile bit flag_is_led_75_percent_enable = 0; // æ ‡å¿—ä½ï¼ŒæŒ‡ç¤ºç¯æ˜¯å¦ä½¿èƒ½
  14          volatile bit flag_is_led_100_percent_enable = 0; // æ ‡å¿—ä½ï¼ŒæŒ‡ç¤ºç¯æ˜¯å¦ä½¿èƒ½
  15          
  16          
  17          
  18          volatile u16 last_pwm_val; // 3260ä½¿ç”¨16ä½ï¼ŒHC15P121B1ä½¿ç”¨8ä½
  19          volatile u16 max_pwm_val;  // 3260ä½¿ç”¨16ä½ï¼ŒHC15P121B1ä½¿ç”¨8ä½
  20          
  21          volatile u16 adc_bat_val;      // é‡‡é›†åˆ°çš„ç”µæ± ç”µå‹
  22          volatile u16 adc_charging_val; // é‡‡é›†åˆ°çš„å……ç”µç”µå‹
  23          volatile u16 tmp_bat_val;
  24          volatile u16 tmp_val; // 3260ä½¿ç”¨16ä½ï¼ŒHC15P121B1ä½¿ç”¨8ä½
  25          volatile u8 tmp_val_cnt;
  26          volatile u16 tmp_val_l[8] = {0};
  27          
  28          void charge_handle(void)
  29          {
  30   1          // å¦‚æœç”µæ± å·²ç»æ»¡ç”µæˆ–æ¥è¿‘æ»¡ç”µï¼Œå¹¶ä¸”æ­¤æ—¶æ²¡æœ‰æ‰“å¼€æ§åˆ¶å……ç”µçš„PWMï¼Œé€€å‡º
  31   1      
  32   1          // å¦‚æœæ²¡æœ‰æ£€æµ‹åˆ°å……ç”µè¾“å…¥ï¼Œé€€å‡º
  33   1      
  34   1      #if 1
  35   1          u8 i = 0;
  36   1      
  37   1          last_pwm_val = ((u16)TMR1_PWMH << 8) | TMR1_PWML; // è¯»å‡ºä¸Šä¸€æ¬¡PWMå ç©ºæ¯”å¯¹åº”çš„å€¼
  38   1          max_pwm_val = (TIMER1_PEROID_VAL + 1);            // è¯»å‡ºPWMå ç©ºæ¯”è®¾å®šçš„ã€æœ€å¤§çš„å€¼
  39   1      
  40   1          /*
  41   1              ä¿®æ”¹ç”µå‹å·®å€¼ï¼Œç”µå‹å·®å€¼ = 203 - (adc_bat_val * 122 / 1000)
  42   1      
  43   1              æ¨å¯¼è¿‡ç¨‹ï¼š
  44   1              åœ¨å……ç”µæ—¶æµ‹å¾—ï¼Œå……ç”µç”µæµ1.1Aå·¦å³ï¼Œå‹å·®ä¸º-30(adå€¼)æ—¶ï¼Œç”µæ± ä¸€ä¾§ç”µå‹ä¸º7.8V(a
             -då€¼ï¼š1917)
  45   1                           å……ç”µç”µæµ1.1Aå·¦å³ï¼Œå‹å·®ä¸º0(adå€¼)æ—¶ï¼Œç”µæ± ä¸€ä¾§ç”µå‹ä¸º6.8V(adå€¼ï¼š167
             -1)
  46   1              å‡è®¾xè½´ä¸ºç”µå‹å¯¹åº”çš„adå€¼ï¼Œyè½´ä¸ºå‹å·®å¯¹åº”çš„adå€¼ï¼Œå»ºç«‹å‚è€ƒåæ ‡ç³»
  47   1              æ ¹æ®è¿™ä¸¤ä¸ªæµ‹è¯•ç‚¹ï¼Œå‘ç°xè½´æ­£å‘å¢é•¿ï¼Œyè½´è´Ÿå‘å¢é•¿ï¼Œç”»å‡ºçš„æ–œçº¿å‘ä¸‹ï¼Œæ–œ
             -ç‡ä¸ºè´Ÿï¼Œæ±‚å‡ºæ–œç‡
  48   1                  k = Î”y/Î”x = (0 - 30) / (1917 - 1671)ï¼Œçº¦ä¸º -0.122
  49   1              å»ºç«‹å…¬å¼ï¼šy = kx + bï¼Œä»£å…¥ï¼Œè§£å¾— b çº¦ä¸º 203 ï¼ˆå››èˆäº”å…¥æ˜¯204ï¼‰
C51 COMPILER V9.60.7.0   MAIN                                                              07/04/2025 17:19:03 PAGE 2   

  50   1              y = kx + b ==> å‹å·® = -0.122 * å……ç”µæ—¶çš„ç”µæ± ç”µå‹ + 203
  51   1              è½¬æ¢æˆå•ç‰‡æœºå¯ä»¥è®¡ç®—çš„å½¢å¼ï¼šå‹å·® = 203 - (å……ç”µæ—¶çš„ç”µæ± ç”µå‹ * 122 / 1000)
  52   1          */
  53   1      
  54   1          /*
  55   1              æ£€æµ‹ç”µæ± ç”µå‹ 1Mä¸Šæ‹‰ã€470Kä¸‹æ‹‰
  56   1              æ£€æµ‹ç”µæ± ç”µå‹çš„åˆ†å‹ç³»æ•° == 470K / (470K + 1M)
  57   1              çº¦ä¸º 0.31972789115646258503401360544218
  58   1          */
  59   1      #if 1
  60   1          tmp_bat_val = adc_bat_val;
  61   1          if (adc_bat_val <= 2837) // å¦‚æœæ£€æµ‹ç”µæ± ç”µå‹å°äº 6.5V
  62   1          {
  63   2              // tmp_bat_val += 30;
  64   2              tmp_bat_val += 70; /* 6.25--1.02ï¼Œ6.35--1.08 */
  65   2          }
  66   1          else if (adc_bat_val <= 3056) // å¦‚æœæ£€æµ‹ç”µæ± ç”µå‹å°äº 7.0V
  67   1          {
  68   2              // tmp_bat_val += 30; //
  69   2              tmp_bat_val += 50; // 6.64--1.01ï¼Œ6.70--1.03ï¼Œ6.80--1.028ï¼Œ6.90--1.10
  70   2              // tmp_bat_val += 70; //
  71   2          }
  72   1          else if (adc_bat_val <= 3188) // å¦‚æœæ£€æµ‹ç”µæ± ç”µå‹å°äº 7.3V
  73   1          {
  74   2              // tmp_bat_val += 20; //
  75   2              tmp_bat_val += 35; // 7.20--1.08ï¼Œ7.25--1.04
  76   2              // tmp_bat_val += 40; // 7.02--1.06ï¼Œ7.13--1.07ï¼Œ7.17--1.115
  77   2              // tmp_bat_val += 60; //
  78   2          }
  79   1          else if (adc_bat_val <= 3326) // å¦‚æœæ£€æµ‹ç”µæ± ç”µå‹å°äº 7.62V
  80   1          {
  81   2              // tmp_bat_val += 10; //
  82   2              tmp_bat_val += 20; // 7.33--0.991ï¼Œ7.37--1.03ï¼Œ7.40--1.021ï¼Œ7.50--1.05
  83   2              // tmp_bat_val += 30; // 7.33--1.087
  84   2              // tmp_bat_val += 40; //
  85   2          }
  86   1          else // å¦‚æœåœ¨å……ç”µæ—¶æ£€æµ‹åˆ°ç”µæ± ç”µå‹å¤§äº
  87   1          {
  88   2              /*
  89   2                  tmp_bat_val += 15;  è¿™ä¸ªæ—¶å€™å¸¸æ€ä¸‹å¯èƒ½åªæœ‰0.97ï¼Œä½†æ˜¯åŠ¨ä¸€ä¸‹çº¿è·¯æ¿æˆ–è€…çº¿ç
             -¼†ï¼Œä¼šè·³åˆ°1.07A
  90   2                  7.76--0.975ï¼Œ7.78--1.04ï¼Œ8.00--1.084
  91   2              */
  92   2              tmp_bat_val += 15;
  93   2              // tmp_bat_val += 25; //
  94   2              // tmp_bat_val += 30; // 7.70--1.06ï¼Œ7.73--1.100ï¼Œ
  95   2              // tmp_bat_val += 35; //
  96   2              // tmp_bat_val += 40; // 7.70--1.16ï¼Œ8.07V -- 1.06Aï¼Œ8.2Vä¹‹åå¥½åƒä¼šå‡åˆ°1.1Aï¼Œ8.23V--1.08
             -A
  97   2              // tmp_bat_val += 45; //
  98   2              // tmp_bat_val += 50; // åœ¨8.08Vä¼šåˆ°1.10
  99   2              // tmp_bat_val += 52; //
 100   2              // tmp_bat_val += 55; //
 101   2              // tmp_bat_val += 60; //   è¶…è¿‡8Vä¼šåˆ°1.10
 102   2              // tmp_bat_val += 70; // è¶…è¿‡8Væ—¶ä¼šè¶…è¿‡1.1Aï¼Œå¯¼è‡´ç”µæ„Ÿå‘çƒ­
 103   2              tmp_bat_val -= ((u32)adc_bat_val * 157 / 1000 - 522);
 104   2          }
 105   1      
 106   1          tmp_bat_val += 50;
 107   1          // tmp_bat_val += 60;
 108   1          // tmp_bat_val += 70;
 109   1          // tmp_bat_val += 80;
C51 COMPILER V9.60.7.0   MAIN                                                              07/04/2025 17:19:03 PAGE 3   

 110   1          // tmp_bat_val += 90;
 111   1      
 112   1          // if (adc_bat_val >= 3579) // 8.2VåŠä»¥ä¸Š , é™ä½ç”µæµ
 113   1          if (adc_bat_val >= 3623) // 8.30VåŠä»¥ä¸Š , é™ä½ç”µæµ
 114   1          {
 115   2              u16 i;
 116   2              // for (i = 0; i < 40; i++) //
 117   2              // for (i = 0; i < 50; i++) //
 118   2              // for (i = 0; i < 70; i++) // 8.33--0.93A
 119   2              // for (i = 0; i < 75; i++) // 8.33--0.86A
 120   2              // for (i = 0; i < 80; i++) // 8.34--0.88
 121   2              // for (i = 0; i < 85; i++) // 8.33V--0.62A
 122   2              // for (i = 0; i < 90; i++) // 8.33--0.866ï¼Œ
 123   2              // for (i = 0; i < 100; i++) // 8.32--0.90Aï¼Œ8.34--0.89
 124   2              for (i = 0; i < 120; i++) //
 125   2              {
 126   3                  if (tmp_bat_val > 2)
 127   3                  {
 128   4                      tmp_bat_val--;
 129   4                  }
 130   3              }
 131   2          }
 132   1      #endif
 133   1      
 134   1          /*
 135   1              å‡å‹å…¬å¼ï¼šVo = Vi / (1 - D)
 136   1      
 137   1              é€šè¿‡PWMæ¥æ§åˆ¶å‡å‹ï¼Œè¿™é‡Œå‡è®¾å½“å‰PWMå ç©ºæ¯”å¯„å­˜å™¨çš„å€¼ ä¸º Dï¼ŒPWMå ç©ºæ¯”å¯„å­
             -˜å™¨å¯ä»¥åˆ°çš„æœ€å¤§çš„å€¼ ä¸º 1
 138   1              Vo = Vi / (PWMå ç©ºæ¯”å¯„å­˜å™¨å¯ä»¥åˆ°çš„æœ€å¤§çš„å€¼ - å½“å‰PWMå ç©ºæ¯”å¯„å­˜å™¨çš„å€¼)
 139   1              å½“å‰PWMå ç©ºæ¯”è¶Šå¤§ï¼ŒVoä¹Ÿè¶Šå¤§ï¼Œå……ç”µçš„ç”µæµä¹Ÿä¼šè¶Šå¤§
 140   1      
 141   1              (PWMå ç©ºæ¯”å¯„å­˜å™¨å¯ä»¥åˆ°çš„æœ€å¤§çš„å€¼ - å½“å‰PWMå ç©ºæ¯”å¯„å­˜å™¨çš„å€¼) = Vi / Vo
 142   1              å½“å‰PWMå ç©ºæ¯”å¯„å­˜å™¨çš„å€¼ = PWMå ç©ºæ¯”å¯„å­˜å™¨å¯ä»¥åˆ°çš„æœ€å¤§çš„å€¼ - Vi / Vo
 143   1      
 144   1              è¿™é‡Œæ£€æµ‹åˆ°çš„å……ç”µç”µå‹çš„adå€¼ == USB-Cå£ç”µå‹ / 2[ä¸Šä¸‹æ‹‰ç”µé˜»åˆ†å‹] / å‚è€ƒç”µå‹
             -[3Vï¼Œé‚£ä¹ˆè¿™é‡Œå°±æ˜¯é™¤ä»¥3] * 4096[adè½¬æ¢ç²¾åº¦ï¼Œ12ä½-->0~4096]
 145   1              å³ï¼Œè¿™é‡Œæ£€æµ‹åˆ°çš„å……ç”µç”µå‹çš„adå€¼ == USB-Cå£ç”µå‹ / 2 / 3 * 4096
 146   1              æ£€æµ‹åˆ°çš„ç”µæ± ç”µå‹çš„adå€¼ == ç”µæ± ç”µå‹ * 0.18 / 3Vå‚è€ƒç”µå‹ * 4096 == ç”µæ± ç”µå‹ * 
             -220 / 1220 / 3Vå‚è€ƒç”µå‹ * 4096
 147   1              (ç”µæ± çš„åˆ†å‹ç”µé˜»ï¼šä¸‹æ‹‰220Kï¼Œä¸Šæ‹‰1Mï¼Œåˆ†å‹ç³»æ•°ï¼š 220 / 1220)
 148   1      
 149   1              æ£€æµ‹å……ç”µç”µå‹å’Œæ£€æµ‹ç”µæ± ç”µå‹ä½¿ç”¨çš„ä¸æ˜¯åŒä¸€ä¸ªåˆ†å‹ç³»æ•°ï¼Œè¦ä¸€èµ·è¿ç®—æ—¶ï¼
             -Œè¿™é‡Œå°†å……ç”µç”µå‹çš„adå† * 2 * 220 / 1220
 150   1              å³ (adc_charging_val * 22 / 61)
 151   1      
 152   1              å†ä»£å›å…¬å¼ï¼šå½“å‰PWMå ç©ºæ¯”å¯„å­˜å™¨çš„å€¼ = PWMå ç©ºæ¯”å¯„å­˜å™¨å¯ä»¥åˆ°çš„æœ€å¤§çš„å€
             -¼ - Vi / Vo
 153   1              å½“å‰PWMå ç©ºæ¯”å¯„å­˜å™¨çš„å€¼ = PWMå ç©ºæ¯”å¯„å­˜å™¨å¯ä»¥åˆ°çš„æœ€å¤§çš„å€¼ - å……ç”µç”µå‹ /
             - å……ç”µæ—¶ç”µæ± ä¸¤ä¾§çš„ç”µå‹
 154   1              tmp_val = max_pwm_val - å……ç”µç”µå‹ / å……ç”µæ—¶ç”µæ± ä¸¤ä¾§çš„ç”µå‹
 155   1              è½¬æ¢æˆå•ç‰‡æœºå¯ä»¥è®¡ç®—çš„å½¢å¼ï¼š
 156   1              tmp_val = max_pwm_val - (adc_charging_val * 22 / 61) / tmp_bat_valï¼Œä½†æ˜¯ max_pwm_val çš„å€¼ä¸æ
             -˜¯1ï¼Œä¸ç¬¦åˆ Vo = Vi / (1 - D)
 157   1              è¿™é‡Œè¦æ”¹æˆ tmp_val = max_pwm_val - max_pwm_val * (adc_charging_val * 22 / 61) / tmp_bat_val
 158   1              tmp_val = max_pwm_val - (adc_charging_val * max_pwm_val * 22 / 61) / tmp_bat_val
 159   1          */
 160   1          // D = 1 - (Vi / Vo)
 161   1          // tmp_val = max_pwm_val - (adc_charging_val * max_pwm_val * 22 / 61) / tmp_bat_val;
 162   1          // tmp_val = max_pwm_val - (adc_charging_val * max_pwm_val * 94 / 147) / tmp_bat_val;
 163   1          // tmp_val = max_pwm_val - ((u32)4095 * max_pwm_val * 94 / 147) / tmp_bat_val;
 164   1      
C51 COMPILER V9.60.7.0   MAIN                                                              07/04/2025 17:19:03 PAGE 4   

 165   1          /*
 166   1              å‡è®¾å……ç”µæ£€æµ‹è„šå¤–éƒ¨ç”¨100Kä¸‹æ‹‰ï¼Œ1Mä¸Šæ‹‰ï¼Œè¾“å…¥ç”µå‹å˜ä¸º1/11åˆ†å‹
 167   1          */
 168   1          // tmp_val = max_pwm_val - (max_pwm_val) * ((u32)adc_charging_val / 4096 * 3 * 11 / 1) / tmp_bat_val *
             - / 4096 *3 * 1470 / 470;
 169   1          tmp_val = max_pwm_val - (max_pwm_val) * ((u32)adc_charging_val * 11 / 1) / tmp_bat_val * 1470 / 470;
 170   1          // tmp_val = max_pwm_val - ((u32)adc_charging_val * max_pwm_val * 1 / 11) / tmp_bat_val; // TODO: å¯è
             -ƒ½è¦æ ¹æ®å¤–éƒ¨è¾“å…¥çš„ç”µå‹èŒƒå›´æ¥ä¿®æ”¹å…¬å¼
 171   1      
 172   1          // adc_charging_val æ”¹æˆäº† adc_initial_charging_valï¼Œåªä½¿ç”¨åˆšæ’å…¥å……ç”µå¤´æ—¶å¯¹åº”çš„adå€¼æ
             -¥ä»£å…¥å…¬å¼ï¼š
 173   1          // tmp_val = max_pwm_val - ((u32)adc_initial_charging_val * max_pwm_val * 94 / 147) / tmp_bat_val;
 174   1      
 175   1          if ((u16)tmp_val >= max_pwm_val) // 3260ä½¿ç”¨16ä½ï¼ŒHC15P121B1ä½¿ç”¨8ä½
 176   1          {
 177   2              // å¦‚æœPWMå ç©ºæ¯”å¯¹åº”çš„å€¼ å¤§äº æœ€å¤§å ç©ºæ¯”å¯¹åº”çš„å€¼ï¼Œè¯´æ˜è®¡ç®—æº¢å‡ºï¼ˆå¯èƒ½
             -æ˜¯ç”µæ± ç”µå‹è¿‡å°ï¼‰ï¼ŒæŒ‰0å¤„ç†
 178   2              tmp_val = 0;
 179   2          }
 180   1      
 181   1          // æ»¤æ³¢æ“ä½œï¼Œä¸€å¼€å§‹tmp_valä¼šå¾ˆå°ï¼Œé‡‡é›†å¤šæ¬¡åè¶‹äºä¸€ä¸ªå¹³å‡å€¼ï¼š
 182   1          tmp_val_cnt++;
 183   1          tmp_val_cnt &= 0x07;
 184   1          tmp_val_l[tmp_val_cnt] = (tmp_val_l[tmp_val_cnt] + tmp_val) >> 1;
 185   1          tmp_val = 0;
 186   1          for (i = 0; i < 8; i++)
 187   1          {
 188   2              tmp_val += tmp_val_l[i];
 189   2          }
 190   1      
 191   1          tmp_val >>= 3;
 192   1      
 193   1          {
 194   2              /*
 195   2                  å¦‚æœå·®å€¼è¿‡å¤§ï¼Œåˆ™å¿«é€Ÿè°ƒèŠ‚ï¼Œå¦‚æœå·®å€¼è¿‡å°ï¼Œåˆ™æ…¢é€Ÿè°ƒèŠ‚ï¼Œ
 196   2                  é˜²æ­¢ç”µæµçªå˜ï¼Œå¯¼è‡´ä¸åŒçš„æ¿å­æœ€ç»ˆå……ç”µç”µæµä¸ä¸€è‡´
 197   2              */
 198   2              if (flag_is_adjust_pwm_time_comes) // è°ƒèŠ‚æ—¶é—´åˆ°æ¥
 199   2              {
 200   3                  flag_is_adjust_pwm_time_comes = 0;
 201   3      
 202   3                  if (tmp_val > last_pwm_val)
 203   3                  {
 204   4      
 205   4                      last_pwm_val++;
 206   4                  }
 207   3                  else if (tmp_val < last_pwm_val)
 208   3                  {
 209   4      
 210   4                      last_pwm_val--;
 211   4                  }
 212   3              }
 213   2          }
 214   1      
 215   1          // T2DATA = last_pwm_val;
 216   1          TMR1_PWMH = last_pwm_val >> 8;
 217   1          TMR1_PWML = last_pwm_val & 0xFF;
 218   1      
 219   1      #endif
 220   1      }
 221          
 222          // ç”µæ± ç±»å‹æ£€æµ‹ï¼ˆåŒ…å«æ£€æµ‹å¼•è„šçš„åˆå§‹åŒ–ï¼‰
C51 COMPILER V9.60.7.0   MAIN                                                              07/04/2025 17:19:03 PAGE 5   

 223          void kind_of_bat_init(void)
 224          {
 225   1          P1_PU |= GPIO_P11_PULL_UP(0x01);      // ä¸Šæ‹‰
 226   1          P1_MD0 &= ~(GPIO_P11_MODE_SEL(0x03)); // è¾“å…¥æ¨¡å¼
 227   1      
 228   1          delay_ms(1);
 229   1      
 230   1          if (LEVEL_LEAD_BATTERY == DETECT_KIND_OF_BAT_PIN)
 231   1          {
 232   2              // æ£€æµ‹è„šæ£€æµ‹åˆ°çš„ç”µå¹³æ˜¯é“…é…¸ç”µæ± å¯¹åº”çš„ç”µå¹³
 233   2              flag_kind_of_bat = KIND_OF_BAT_LEAD; // é“…é…¸ç”µæ± 
 234   2          }
 235   1          else
 236   1          {
 237   2              // æ£€æµ‹è„šæ£€æµ‹åˆ°çš„ç”µå¹³æ˜¯é”‚ç”µæ± å¯¹åº”çš„ç”µå¹³
 238   2              flag_kind_of_bat = KIND_OF_BAT_LITHIUM; // é”‚ç”µæ± 
 239   2          }
 240   1      
 241   1      #if USE_MY_DEBUG
 242   1      
 243   1          if (KIND_OF_BAT_LEAD == flag_kind_of_bat) // é“…é…¸ç”µæ± 
 244   1          {
 245   2              printf("lead battery\n");
 246   2          }
 247   1          else
 248   1          {
 249   2              printf("lithium battery\n");
 250   2          }
 251   1      
 252   1      #endif
 253   1      }
 254          
 255          // æŒ‡ç¤ºç¯å¼•è„š
 256          // ç”µæ± ç”µé‡æŒ‡ç¤ºç¯å¼•è„š
 257          void led_config(void)
 258          {
 259   1          P1_MD0 &= ~GPIO_P12_MODE_SEL(0x03);
 260   1          P1_MD0 |= GPIO_P12_MODE_SEL(0x01);
 261   1          FOUT_S12 = GPIO_FOUT_AF_FUNC;
 262   1          // P12 = LED_OFF_LEVEL; // å¦‚æœä¸ç»™åˆå§‹å€¼ï¼Œä¸Šç”µä¹‹åï¼ŒæŒ‡ç¤ºç¯ä¼šé—ªä¸€ä¸‹
 263   1          LED_25_PERCENT_OFF();
 264   1      
 265   1          P1_MD0 &= ~GPIO_P13_MODE_SEL(0x03);
 266   1          P1_MD0 |= GPIO_P13_MODE_SEL(0x01);
 267   1          FOUT_S13 = GPIO_FOUT_AF_FUNC;
 268   1          // P13 = LED_OFF_LEVEL;
 269   1          LED_50_PERCENT_OFF();
 270   1      
 271   1          P1_MD1 &= ~GPIO_P14_MODE_SEL(0x03);
 272   1          P1_MD1 |= GPIO_P14_MODE_SEL(0x01);
 273   1          FOUT_S14 = GPIO_FOUT_AF_FUNC;
 274   1          // P14 = LED_OFF_LEVEL;
 275   1          LED_75_PERCENT_OFF();
 276   1      
 277   1          P1_MD1 &= ~GPIO_P15_MODE_SEL(0x03);
 278   1          P1_MD1 |= GPIO_P15_MODE_SEL(0x01);
 279   1          FOUT_S15 = GPIO_FOUT_AF_FUNC;
 280   1          // P15 = LED_OFF_LEVEL;
 281   1          LED_100_PERCENT_OFF();
 282   1      }
 283          
 284          // å……ç”µæ£€æµ‹
C51 COMPILER V9.60.7.0   MAIN                                                              07/04/2025 17:19:03 PAGE 6   

 285          void charging_detect(void)
 286          {
 287   1      #if 0
                  if (adc_charging_val >= ) // å¤§äºå……ç”µé˜ˆå€¼ï¼Œè¯´æ˜æ£€æµ‹åˆ°äº†å……ç”µ
                  {
                      flag_is_charging_detected = 1;
                  }
                  else if (adc_charging_val < ) // å°äºå……ç”µé˜ˆå€¼ - æ­»åŒºï¼Œè¯´æ˜æ²¡æœ‰æ£€æµ‹åˆ°å……ç”µ
                  {
                      flag_is_charging_detected = 0;
                  }
              #endif
 297   1      }
 298          
 299          // ç”µæ± ç”µé‡æŒ‡ç¤ºç¯æ§åˆ¶
 300          void led_handle(void)
 301          {
 302   1          // static u8 last_bat_level = 4; //
 303   1          static bit flag_last_charging_status = 0;
 304   1      
 305   1          if (flag_is_in_charging)
 306   1          {
 307   2              // å¦‚æœæ­£åœ¨å……ç”µ
 308   2              // å……ç”µæ—¶ï¼Œå¦‚æœç”µæ± ç”µé‡å‡é«˜ï¼Œä¾‹å¦‚ï¼šä»3æ ¼æŒ‡ç¤ºç¯å˜ä¸º4æ ¼æŒ‡ç¤ºç¯ï¼ŒæŒ‡ç¤ºç¯
             -ä¸èƒ½å†å˜å›3æ ¼æŒ‡ç¤ºç¯ï¼Œé˜²æ­¢æŒ‡ç¤ºç¯é—ªçƒï¼Œé™¤éé€€å‡ºäº†å……ç”µ
 309   2      
 310   2              if (KIND_OF_BAT_LEAD == flag_kind_of_bat) // å¦‚æœæ˜¯é“…é…¸ç”µæ± 
 311   2              {
 312   3                  // if (adc_bat_val >= )  // 25%
 313   3                  {
 314   4                  }
 315   3      
 316   3                  // if (adc_bat_val >= ) // 50%
 317   3                  {
 318   4                  }
 319   3      
 320   3                  // if (adc_bat_val >= ) // 75%
 321   3                  {
 322   4                  }
 323   3      
 324   3                  // if (adc_bat_val >= ) // 100%
 325   3                  {
 326   4                  }
 327   3              }
 328   2              else // å¦‚æœæ˜¯é”‚ç”µæ± 
 329   2              {
 330   3                  if (adc_bat_val >= ADC_VAL_CHARGE_25_PERCENT_OF_LITHIUM_BATTERY)  // 25%
 331   3                  {
 332   4                  }
 333   3      
 334   3                  if (adc_bat_val >= ADC_VAL_CHARGE_50_PERCENT_OF_LITHIUM_BATTERY) // 50%
 335   3                  {
 336   4                  }
 337   3      
 338   3                  if (adc_bat_val >= ADC_VAL_CHARGE_75_PERCENT_OF_LITHIUM_BATTERY) // 75%
 339   3                  {
 340   4                  }
 341   3      
 342   3                  if (adc_bat_val >= ADC_VAL_CHARGE_100_PERCENT_OF_LITHIUM_BATTERY) // 100%
 343   3                  {
 344   4                  }
 345   3              }
C51 COMPILER V9.60.7.0   MAIN                                                              07/04/2025 17:19:03 PAGE 7   

 346   2          }
 347   1          else
 348   1          {
 349   2              // å¦‚æœä¸åœ¨å……ç”µ
 350   2              // æ”¾ç”µæ—¶ï¼Œå¦‚æœç”µæ± ç”µé‡é™ä½ï¼Œä¾‹å¦‚ï¼šä»4æ ¼æŒ‡ç¤ºç¯å˜ä¸º3æ ¼æŒ‡ç¤ºç¯ï¼ŒæŒ‡ç¤ºç¯
             -ä¸èƒ½å†å˜å›4æ ¼æŒ‡ç¤ºç¯ï¼Œé˜²æ­¢æŒ‡ç¤ºç¯é—ªçƒï¼Œé™¤éåˆè¿›è¡Œäº†å……ç”µ
 351   2      
 352   2              if (KIND_OF_BAT_LEAD == flag_kind_of_bat) // å¦‚æœæ˜¯é“…é…¸ç”µæ± 
 353   2              {
 354   3                  // if (adc_bat_val >= )  // 25%
 355   3                  {
 356   4                  }
 357   3      
 358   3                  // if (adc_bat_val >= ) // 50%
 359   3                  {
 360   4                  }
 361   3      
 362   3                  // if (adc_bat_val >= ) // 75%
 363   3                  {
 364   4                  }
 365   3      
 366   3                  // if (adc_bat_val >= ) // 100%
 367   3                  {
 368   4                  }
 369   3              }
 370   2              else // å¦‚æœæ˜¯é”‚ç”µæ± 
 371   2              {
 372   3                  // if (adc_bat_val >= )  // 25%
 373   3                  {
 374   4                  }
 375   3      
 376   3                  // if (adc_bat_val >= ) // 50%
 377   3                  {
 378   4                  }
 379   3      
 380   3                  // if (adc_bat_val >= ) // 75%
 381   3                  {
 382   4                  }
 383   3      
 384   3                  // if (adc_bat_val >= ) // 100%
 385   3                  {
 386   4                  }
 387   3              }
 388   2          }
 389   1      }
*** WARNING C280 IN LINE 303 OF ..\..\User\main.c: 'flag_last_charging_status': unreferenced local variable
 390          
 391          void user_init(void)
 392          {
 393   1      // DEBUG:
 394   1      #if USE_MY_DEBUG
 395   1          uart0_config();
 396   1      #endif
 397   1      
 398   1          adc_config();
 399   1          timer0_config();
 400   1          timer1_pwm_config();
 401   1      
 402   1          timer1_pwm_disable();
 403   1      
 404   1          delay_ms(1); // ç­‰å¾…ç³»ç»Ÿç¨³å®š
 405   1          kind_of_bat_init();
C51 COMPILER V9.60.7.0   MAIN                                                              07/04/2025 17:19:03 PAGE 8   

 406   1      }
 407          
 408          /**
 409           * @brief  Main program.
 410           * @param  None
 411           * @retval None
 412           */
 413          void main(void)
 414          {
 415   1          // çœ‹é—¨ç‹—é»˜è®¤æ‰“å¼€, å¤ä½æ—¶é—´2s
 416   1          system_init();
 417   1      
 418   1          WDT_KEY = WDT_KEY_VAL(0xDD); // å…³é—­çœ‹é—¨ç‹—
 419   1      
 420   1          // å…³é—­HCKå’ŒHDAçš„è°ƒè¯•åŠŸèƒ½
 421   1          WDT_KEY = 0x55;  // è§£é™¤å†™ä¿æŠ¤
 422   1          IO_MAP &= ~0x01; // æ¸…é™¤è¿™ä¸ªå¯„å­˜å™¨çš„å€¼ï¼Œå®ç°å…³é—­HCKå’ŒHDAå¼•è„šçš„è°ƒè¯•åŠŸèƒ½ï¼ˆè§£é™¤æ
             -˜ å°„ï¼‰
 423   1          WDT_KEY = 0xBB;
 424   1      
 425   1          /* ç”¨æˆ·ä»£ç åˆå§‹åŒ–æ¥å£ */
 426   1          user_init();
 427   1      
 428   1          // DEBUG:
 429   1          flag_kind_of_bat = KIND_OF_BAT_LITHIUM; // æµ‹è¯•ç”¨
 430   1      
 431   1          timer1_set_pwm_duty_val(1);
 432   1          timer1_pwm_enable();
 433   1      
 434   1          /* ç³»ç»Ÿä¸»å¾ªç¯ */
 435   1          while (1)
 436   1          {
 437   2              adc_sel_pin(ADC_SEL_PIN_GET_BAT);
 438   2              adc_bat_val = adc_getval();
 439   2      
 440   2              adc_sel_pin(ADC_SEL_PIN_GET_CHARGE);
 441   2              adc_charging_val = adc_getval();
 442   2              charge_handle();
 443   2          }
 444   1      }
 445          
 446          
 447          /**
 448           * @}
 449           */
 450          
 451          /*************************** (C) COPYRIGHT 2022 HUGE-IC ***** END OF FILE *****/


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    860    ----
   CONSTANT SIZE    =     31    ----
   XDATA SIZE       =     29       3
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      9    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  1 WARNING(S),  0 ERROR(S)
