C51 COMPILER V9.60.7.0   MAIN                                                              07/03/2025 17:01:32 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Release\Objects\main.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE ..\..\User\main.c LARGE OPTIMIZE(8,SIZE) BROWSE INTVECTOR(0X000C) INCDIR
                    -(..\..\Libraries\Include;..\..\User;..\..\User\lib;..\..\Hardware;..\..\Lowpower) INTERVAL(3) DEBUG OBJECTEXTEND PRINT(.
                    -\Release\Listings\main.lst) OBJECT(.\Release\Objects\main.obj)

line level    source

   1          // use encoding UTF-8
   2          #include "include.h"
   3          #include "my_config.h"
   4          
   5          volatile bit flag_is_charging_detected = 0; // æ ‡å¿—ä½ï¼Œæ˜¯å¦æ£€æµ‹åˆ°å……ç”µ
   6          volatile bit flag_is_adjust_pwm_time_comes = 0;
   7          
   8          volatile u16 last_pwm_val;
   9          volatile u16 max_pwm_val;
  10          
  11          volatile u16 adc_bat_val;      // é‡‡é›†åˆ°çš„ç”µæ± ç”µå‹
  12          volatile u16 adc_charging_val; // é‡‡é›†åˆ°çš„å……ç”µç”µå‹
  13          volatile u16 tmp_bat_val;
  14          volatile u16 tmp_val;
  15          volatile u8 tmp_val_cnt;
  16          volatile u16 tmp_val_l[8] = 0;
  17          
  18          void charge_handle(void)
  19          {
  20   1      #if 1
  21   1          u8 i = 0;
  22   1      
  23   1          last_pwm_val = ((u16)TMR1_PWMH << 8) | TMR1_PWML; // è¯»å‡ºä¸Šä¸€æ¬¡PWMå ç©ºæ¯”å¯¹åº”çš„å€¼
  24   1          max_pwm_val = (TIMER1_PEROID_VAL + 1);            // è¯»å‡ºPWMå ç©ºæ¯”è®¾å®šçš„ã€æœ€å¤§çš„å€¼
  25   1      
  26   1          /*
  27   1              ä¿®æ”¹ç”µå‹å·®å€¼ï¼Œç”µå‹å·®å€¼ = 203 - (adc_bat_val * 122 / 1000)
  28   1      
  29   1              æ¨å¯¼è¿‡ç¨‹ï¼š
  30   1              åœ¨å……ç”µæ—¶æµ‹å¾—ï¼Œå……ç”µç”µæµ1.1Aå·¦å³ï¼Œå‹å·®ä¸º-30(adå€¼)æ—¶ï¼Œç”µæ± ä¸€ä¾§ç”µå‹ä¸º7.8V(a
             -då€¼ï¼š1917)
  31   1                           å……ç”µç”µæµ1.1Aå·¦å³ï¼Œå‹å·®ä¸º0(adå€¼)æ—¶ï¼Œç”µæ± ä¸€ä¾§ç”µå‹ä¸º6.8V(adå€¼ï¼š167
             -1)
  32   1              å‡è®¾xè½´ä¸ºç”µå‹å¯¹åº”çš„adå€¼ï¼Œyè½´ä¸ºå‹å·®å¯¹åº”çš„adå€¼ï¼Œå»ºç«‹å‚è€ƒåæ ‡ç³»
  33   1              æ ¹æ®è¿™ä¸¤ä¸ªæµ‹è¯•ç‚¹ï¼Œå‘ç°xè½´æ­£å‘å¢é•¿ï¼Œyè½´è´Ÿå‘å¢é•¿ï¼Œç”»å‡ºçš„æ–œçº¿å‘ä¸‹ï¼Œæ–œ
             -ç‡ä¸ºè´Ÿï¼Œæ±‚å‡ºæ–œç‡
  34   1                  k = Î”y/Î”x = (0 - 30) / (1917 - 1671)ï¼Œçº¦ä¸º -0.122
  35   1              å»ºç«‹å…¬å¼ï¼šy = kx + bï¼Œä»£å…¥ï¼Œè§£å¾— b çº¦ä¸º 203 ï¼ˆå››èˆäº”å…¥æ˜¯204ï¼‰
  36   1              y = kx + b ==> å‹å·® = -0.122 * å……ç”µæ—¶çš„ç”µæ± ç”µå‹ + 203
  37   1              è½¬æ¢æˆå•ç‰‡æœºå¯ä»¥è®¡ç®—çš„å½¢å¼ï¼šå‹å·® = 203 - (å……ç”µæ—¶çš„ç”µæ± ç”µå‹ * 122 / 1000)
  38   1          */
  39   1      
  40   1          /*
  41   1              æ£€æµ‹ç”µæ± ç”µå‹ 1Mä¸Šæ‹‰ã€470Kä¸‹æ‹‰
  42   1              æ£€æµ‹ç”µæ± ç”µå‹çš„åˆ†å‹ç³»æ•° == 470K / (470K + 1M)
  43   1              çº¦ä¸º 0.31972789115646258503401360544218
  44   1          */
  45   1      #if 1
  46   1          tmp_bat_val = adc_bat_val;
  47   1          if (adc_bat_val <= 2837) // å¦‚æœæ£€æµ‹ç”µæ± ç”µå‹å°äº 6.5V
  48   1          {
  49   2              // tmp_bat_val += 30;
  50   2              tmp_bat_val += 70; /* 6.25--1.02ï¼Œ6.35--1.08 */
C51 COMPILER V9.60.7.0   MAIN                                                              07/03/2025 17:01:32 PAGE 2   

  51   2          }
  52   1          else if (adc_bat_val <= 3056) // å¦‚æœæ£€æµ‹ç”µæ± ç”µå‹å°äº 7.0V
  53   1          {
  54   2              // tmp_bat_val += 30; //
  55   2              tmp_bat_val += 50; // 6.64--1.01ï¼Œ6.70--1.03ï¼Œ6.80--1.028ï¼Œ6.90--1.10
  56   2              // tmp_bat_val += 70; //
  57   2          }
  58   1          else if (adc_bat_val <= 3188) // å¦‚æœæ£€æµ‹ç”µæ± ç”µå‹å°äº 7.3V
  59   1          {
  60   2              // tmp_bat_val += 20; //
  61   2              tmp_bat_val += 35; // 7.20--1.08ï¼Œ7.25--1.04
  62   2              // tmp_bat_val += 40; // 7.02--1.06ï¼Œ7.13--1.07ï¼Œ7.17--1.115
  63   2              // tmp_bat_val += 60; //
  64   2          }
  65   1          else if (adc_bat_val <= 3326) // å¦‚æœæ£€æµ‹ç”µæ± ç”µå‹å°äº 7.62V
  66   1          {
  67   2              // tmp_bat_val += 10; //
  68   2              tmp_bat_val += 20; // 7.33--0.991ï¼Œ7.37--1.03ï¼Œ7.40--1.021ï¼Œ7.50--1.05
  69   2              // tmp_bat_val += 30; // 7.33--1.087
  70   2              // tmp_bat_val += 40; //
  71   2          }
  72   1          else // å¦‚æœåœ¨å……ç”µæ—¶æ£€æµ‹åˆ°ç”µæ± ç”µå‹å¤§äº
  73   1          {
  74   2              /*
  75   2                  tmp_bat_val += 15;  è¿™ä¸ªæ—¶å€™å¸¸æ€ä¸‹å¯èƒ½åªæœ‰0.97ï¼Œä½†æ˜¯åŠ¨ä¸€ä¸‹çº¿è·¯æ¿æˆ–è€…çº¿ç
             -¼†ï¼Œä¼šè·³åˆ°1.07A
  76   2                  7.76--0.975ï¼Œ7.78--1.04ï¼Œ8.00--1.084
  77   2              */
  78   2              tmp_bat_val += 15;
  79   2              // tmp_bat_val += 25; //
  80   2              // tmp_bat_val += 30; // 7.70--1.06ï¼Œ7.73--1.100ï¼Œ
  81   2              // tmp_bat_val += 35; //
  82   2              // tmp_bat_val += 40; // 7.70--1.16ï¼Œ8.07V -- 1.06Aï¼Œ8.2Vä¹‹åå¥½åƒä¼šå‡åˆ°1.1Aï¼Œ8.23V--1.08
             -A
  83   2              // tmp_bat_val += 45; //
  84   2              // tmp_bat_val += 50; // åœ¨8.08Vä¼šåˆ°1.10
  85   2              // tmp_bat_val += 52; //
  86   2              // tmp_bat_val += 55; //
  87   2              // tmp_bat_val += 60; //   è¶…è¿‡8Vä¼šåˆ°1.10
  88   2              // tmp_bat_val += 70; // è¶…è¿‡8Væ—¶ä¼šè¶…è¿‡1.1Aï¼Œå¯¼è‡´ç”µæ„Ÿå‘çƒ­
  89   2              tmp_bat_val -= ((u32)adc_bat_val * 157 / 1000 - 522);
  90   2          }
  91   1      
  92   1          tmp_bat_val += 50;
  93   1          // tmp_bat_val += 60;
  94   1          // tmp_bat_val += 70;
  95   1          // tmp_bat_val += 80;
  96   1          // tmp_bat_val += 90;
  97   1      
  98   1          // if (adc_bat_val >= 3579) // 8.2VåŠä»¥ä¸Š , é™ä½ç”µæµ
  99   1          if (adc_bat_val >= 3623) // 8.30VåŠä»¥ä¸Š , é™ä½ç”µæµ
 100   1          {
 101   2              u16 i;
 102   2              // for (i = 0; i < 40; i++) //
 103   2              // for (i = 0; i < 50; i++) //
 104   2              // for (i = 0; i < 70; i++) // 8.33--0.93A
 105   2              // for (i = 0; i < 75; i++) // 8.33--0.86A
 106   2              // for (i = 0; i < 80; i++) // 8.34--0.88
 107   2              // for (i = 0; i < 85; i++) // 8.33V--0.62A
 108   2              // for (i = 0; i < 90; i++) // 8.33--0.866ï¼Œ
 109   2              // for (i = 0; i < 100; i++) // 8.32--0.90Aï¼Œ8.34--0.89
 110   2              for (i = 0; i < 120; i++) //
C51 COMPILER V9.60.7.0   MAIN                                                              07/03/2025 17:01:32 PAGE 3   

 111   2              {
 112   3                  if (tmp_bat_val > 2)
 113   3                  {
 114   4                      tmp_bat_val--;
 115   4                  }
 116   3              }
 117   2          }
 118   1      #endif
 119   1      
 120   1          /*
 121   1              å‡å‹å…¬å¼ï¼šVo = Vi / (1 - D)
 122   1      
 123   1              é€šè¿‡PWMæ¥æ§åˆ¶å‡å‹ï¼Œè¿™é‡Œå‡è®¾å½“å‰PWMå ç©ºæ¯”å¯„å­˜å™¨çš„å€¼ ä¸º Dï¼ŒPWMå ç©ºæ¯”å¯„å­
             -˜å™¨å¯ä»¥åˆ°çš„æœ€å¤§çš„å€¼ ä¸º 1
 124   1              Vo = Vi / (PWMå ç©ºæ¯”å¯„å­˜å™¨å¯ä»¥åˆ°çš„æœ€å¤§çš„å€¼ - å½“å‰PWMå ç©ºæ¯”å¯„å­˜å™¨çš„å€¼)
 125   1              å½“å‰PWMå ç©ºæ¯”è¶Šå¤§ï¼ŒVoä¹Ÿè¶Šå¤§ï¼Œå……ç”µçš„ç”µæµä¹Ÿä¼šè¶Šå¤§
 126   1      
 127   1              (PWMå ç©ºæ¯”å¯„å­˜å™¨å¯ä»¥åˆ°çš„æœ€å¤§çš„å€¼ - å½“å‰PWMå ç©ºæ¯”å¯„å­˜å™¨çš„å€¼) = Vi / Vo
 128   1              å½“å‰PWMå ç©ºæ¯”å¯„å­˜å™¨çš„å€¼ = PWMå ç©ºæ¯”å¯„å­˜å™¨å¯ä»¥åˆ°çš„æœ€å¤§çš„å€¼ - Vi / Vo
 129   1      
 130   1              è¿™é‡Œæ£€æµ‹åˆ°çš„å……ç”µç”µå‹çš„adå€¼ == USB-Cå£ç”µå‹ / 2[ä¸Šä¸‹æ‹‰ç”µé˜»åˆ†å‹] / å‚è€ƒç”µå‹
             -[3Vï¼Œé‚£ä¹ˆè¿™é‡Œå°±æ˜¯é™¤ä»¥3] * 4096[adè½¬æ¢ç²¾åº¦ï¼Œ12ä½-->0~4096]
 131   1              å³ï¼Œè¿™é‡Œæ£€æµ‹åˆ°çš„å……ç”µç”µå‹çš„adå€¼ == USB-Cå£ç”µå‹ / 2 / 3 * 4096
 132   1              æ£€æµ‹åˆ°çš„ç”µæ± ç”µå‹çš„adå€¼ == ç”µæ± ç”µå‹ * 0.18 / 3Vå‚è€ƒç”µå‹ * 4096 == ç”µæ± ç”µå‹ * 
             -220 / 1220 / 3Vå‚è€ƒç”µå‹ * 4096
 133   1              (ç”µæ± çš„åˆ†å‹ç”µé˜»ï¼š ä¸Šæ‹‰220Kï¼Œä¸‹æ‹‰1Mï¼Œåˆ†å‹ç³»æ•°ï¼š 220 / 1220)
 134   1      
 135   1              æ£€æµ‹å……ç”µç”µå‹å’Œæ£€æµ‹ç”µæ± ç”µå‹ä½¿ç”¨çš„ä¸æ˜¯åŒä¸€ä¸ªåˆ†å‹ç³»æ•°ï¼Œè¦ä¸€èµ·è¿ç®—æ—¶ï¼
             -Œè¿™é‡Œå°†å……ç”µç”µå‹çš„adå† * 2 * 220 / 1220
 136   1              å³ (adc_charging_val * 22 / 61)
 137   1      
 138   1              å†ä»£å›å…¬å¼ï¼šå½“å‰PWMå ç©ºæ¯”å¯„å­˜å™¨çš„å€¼ = PWMå ç©ºæ¯”å¯„å­˜å™¨å¯ä»¥åˆ°çš„æœ€å¤§çš„å€
             -¼ - Vi / Vo
 139   1              å½“å‰PWMå ç©ºæ¯”å¯„å­˜å™¨çš„å€¼ = PWMå ç©ºæ¯”å¯„å­˜å™¨å¯ä»¥åˆ°çš„æœ€å¤§çš„å€¼ - å……ç”µç”µå‹ /
             - å……ç”µæ—¶ç”µæ± ä¸¤ä¾§çš„ç”µå‹
 140   1              tmp_val = max_pwm_val - å……ç”µç”µå‹ / å……ç”µæ—¶ç”µæ± ä¸¤ä¾§çš„ç”µå‹
 141   1              è½¬æ¢æˆå•ç‰‡æœºå¯ä»¥è®¡ç®—çš„å½¢å¼ï¼š
 142   1              tmp_val = max_pwm_val - (adc_charging_val * 22 / 61) / tmp_bat_valï¼Œä½†æ˜¯ max_pwm_val çš„å€¼ä¸æ
             -˜¯1ï¼Œä¸ç¬¦åˆ Vo = Vi / (1 - D)
 143   1              è¿™é‡Œè¦æ”¹æˆ tmp_val = max_pwm_val - max_pwm_val * (adc_charging_val * 22 / 61) / tmp_bat_val
 144   1              tmp_val = max_pwm_val - (adc_charging_val * max_pwm_val * 22 / 61) / tmp_bat_val
 145   1          */
 146   1          // D = 1 - (Vi / Vo)
 147   1          // tmp_val = max_pwm_val - (adc_charging_val * max_pwm_val * 22 / 61) / tmp_bat_val;
 148   1          // tmp_val = max_pwm_val - (adc_charging_val * max_pwm_val * 94 / 147) / tmp_bat_val;
 149   1          tmp_val = max_pwm_val - ((u32)4095 * max_pwm_val * 94 / 147) / tmp_bat_val;
 150   1      
 151   1          // adc_charging_val æ”¹æˆäº† adc_initial_charging_valï¼Œåªä½¿ç”¨åˆšæ’å…¥å……ç”µå¤´æ—¶å¯¹åº”çš„adå€¼æ
             -¥ä»£å…¥å…¬å¼ï¼š
 152   1          // tmp_val = max_pwm_val - ((u32)adc_initial_charging_val * max_pwm_val * 94 / 147) / tmp_bat_val;
 153   1      
 154   1          if (tmp_val >= max_pwm_val)
 155   1          {
 156   2              // å¦‚æœPWMå ç©ºæ¯”å¯¹åº”çš„å€¼ å¤§äº æœ€å¤§å ç©ºæ¯”å¯¹åº”çš„å€¼ï¼Œè¯´æ˜è®¡ç®—æº¢å‡ºï¼ˆå¯èƒ½
             -æ˜¯ç”µæ± ç”µå‹è¿‡å°ï¼‰ï¼ŒæŒ‰0å¤„ç†
 157   2              tmp_val = 0;
 158   2          }
 159   1      
 160   1          // æ»¤æ³¢æ“ä½œï¼Œä¸€å¼€å§‹tmp_valä¼šå¾ˆå°ï¼Œé‡‡é›†å¤šæ¬¡åè¶‹äºä¸€ä¸ªå¹³å‡å€¼ï¼š
 161   1          tmp_val_cnt++;
 162   1          tmp_val_cnt &= 0x07;
 163   1          tmp_val_l[tmp_val_cnt] = (tmp_val_l[tmp_val_cnt] + tmp_val) >> 1;
C51 COMPILER V9.60.7.0   MAIN                                                              07/03/2025 17:01:32 PAGE 4   

 164   1          tmp_val = 0;
 165   1          for (i = 0; i < 8; i++)
 166   1          {
 167   2              tmp_val += tmp_val_l[i];
 168   2          }
 169   1      
 170   1          tmp_val >>= 3;
 171   1      
 172   1          {
 173   2              /*
 174   2                  å¦‚æœå·®å€¼è¿‡å¤§ï¼Œåˆ™å¿«é€Ÿè°ƒèŠ‚ï¼Œå¦‚æœå·®å€¼è¿‡å°ï¼Œåˆ™æ…¢é€Ÿè°ƒèŠ‚ï¼Œ
 175   2                  é˜²æ­¢ç”µæµçªå˜ï¼Œå¯¼è‡´ä¸åŒçš„æ¿å­æœ€ç»ˆå……ç”µç”µæµä¸ä¸€è‡´
 176   2              */
 177   2              if (flag_is_adjust_pwm_time_comes) // è°ƒèŠ‚æ—¶é—´åˆ°æ¥
 178   2              {
 179   3                  flag_is_adjust_pwm_time_comes = 0;
 180   3      
 181   3                  if (tmp_val > last_pwm_val)
 182   3                  {
 183   4      
 184   4                      last_pwm_val++;
 185   4                  }
 186   3                  else if (tmp_val < last_pwm_val)
 187   3                  {
 188   4      
 189   4                      last_pwm_val--;
 190   4                  }
 191   3              }
 192   2          }
 193   1      
 194   1          // T2DATA = last_pwm_val;
 195   1          TMR1_PWMH = last_pwm_val >> 8;
 196   1          TMR1_PWML = last_pwm_val & 0xFF;
 197   1      
 198   1      #endif
 199   1      }
 200          
 201          void user_init(void)
 202          {
 203   1          adc_config();
 204   1          timer0_config();
 205   1          timer1_pwm_config();
 206   1      
 207   1          timer1_pwm_disable();
 208   1      }
 209          
 210          /**
 211           * @brief  Main program.
 212           * @param  None
 213           * @retval None
 214           */
 215          void main(void)
 216          {
 217   1          // çœ‹é—¨ç‹—é»˜è®¤æ‰“å¼€, å¤ä½æ—¶é—´2s
 218   1          system_init();
 219   1      
 220   1          WDT_KEY = WDT_KEY_VAL(0xDD); // å…³é—­çœ‹é—¨ç‹—
 221   1      
 222   1          // å…³é—­HCKå’ŒHDAçš„è°ƒè¯•åŠŸèƒ½
 223   1          WDT_KEY = 0x55;  // è§£é™¤å†™ä¿æŠ¤
 224   1          IO_MAP &= ~0x01; // æ¸…é™¤è¿™ä¸ªå¯„å­˜å™¨çš„å€¼ï¼Œå®ç°å…³é—­HCKå’ŒHDAå¼•è„šçš„è°ƒè¯•åŠŸèƒ½ï¼ˆè§£é™¤æ
             -˜ å°„ï¼‰
C51 COMPILER V9.60.7.0   MAIN                                                              07/03/2025 17:01:32 PAGE 5   

 225   1          WDT_KEY = 0xBB;
 226   1      
 227   1          /* ç”¨æˆ·ä»£ç åˆå§‹åŒ–æ¥å£ */
 228   1          user_init();
 229   1      
 230   1          timer1_set_pwm_duty_val(1);
 231   1          timer1_pwm_enable();
 232   1      
 233   1          /* ç³»ç»Ÿä¸»å¾ªç¯ */
 234   1          while (1)
 235   1          {
 236   2              // adc_sel_pin(ADC_SEL_PIN_GET_BAT);
 237   2              // adc_bat_val = adc_getval();
 238   2              // charge_handle(); 
 239   2          }
 240   1      }
 241          
 242          /**
 243           * @}
 244           */
 245          
 246          /*************************** (C) COPYRIGHT 2022 HUGE-IC ***** END OF FILE *****/


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    638    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =     29       3
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      2    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
